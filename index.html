<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–µ—Ä–µ–≤–æ–¥—á–∏–∫ –ß–∞—Ç - –†—É—Å—Å–∫–∏–π ‚áÑ ‰∏≠Êñá</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üó£Ô∏è</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.8;
            font-size: 14px;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        select, button {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #4b5563;
            background: #374151;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }

        button {
            background: #2563eb;
        }

        button:hover {
            background: #1d4ed8;
        }

        .clear-btn {
            background: #dc2626 !important;
        }

        .clear-btn:hover {
            background: #b91c1c !important;
        }

        .sync-btn {
            background: #059669 !important;
        }

        .sync-btn.active {
            background: #10b981 !important;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        .sync-btn:hover {
            background: #047857 !important;
        }

        .messages {
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            padding: 20px;
            min-height: 400px;
            margin-bottom: 20px;
            overflow-y: auto;
        }

        .empty-state {
            text-align: center;
            padding-top: 100px;
            opacity: 0.6;
        }

        .empty-state .icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .message {
            background: rgba(59, 130, 246, 0.1);
            border-left: 4px solid #3b82f6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .message-header {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .message-original {
            background: rgba(0,0,0,0.2);
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 14px;
            opacity: 0.8;
        }

        .message-text {
            font-size: 16px;
            font-weight: bold;
        }

        .input-area {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 20px;
        }

        .input-controls {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        textarea {
            flex: 1;
            min-width: 250px;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #4b5563;
            background: #374151;
            color: white;
            resize: none;
            min-height: 50px;
            font-size: 16px;
            font-family: Arial, sans-serif;
        }

        textarea::placeholder {
            color: #9ca3af;
        }

        .voice-btn {
            background: #16a34a;
            padding: 12px 16px;
            font-size: 16px;
            min-width: 50px;
        }

        .voice-btn.recording {
            background: #dc2626;
            animation: pulse 1s infinite;
        }

        .send-btn {
            padding: 12px 20px;
            font-size: 16px;
            font-weight: bold;
            min-width: 100px;
        }

        .send-btn:disabled {
            background: #6b7280 !important;
            cursor: not-allowed;
        }

        .info {
            text-align: center;
            margin-top: 10px;
            font-size: 12px;
            opacity: 0.6;
        }

        .loading {
            display: flex;
            justify-content: center;
            margin: 10px 0;
        }

        .loading div {
            background: #374151;
            padding: 10px 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #4b5563;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .input-controls {
                flex-direction: column;
            }

            textarea {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>üó£Ô∏è –ü–µ—Ä–µ–≤–æ–¥—á–∏–∫ –ß–∞—Ç</h1>
                <p>–†—É—Å—Å–∫–∏–π ‚áÑ ‰∏≠Êñá</p>
            </div>
            
            <div class="controls">
                <select id="languageSelect">
                    <option value="ru">–†—É—Å—Å–∫–∏–π ‚Üí ‰∏≠Êñá</option>
                    <option value="zh">‰∏≠Êñá ‚Üí –†—É—Å—Å–∫–∏–π</option>
                </select>
                
                <button id="syncBtn" onclick="toggleSync()" title="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏">
                    üîÑ –°–∏–Ω—Ö—Ä
                </button>
                
                <button class="clear-btn" onclick="clearChat()">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
        </div>
        
        <!-- Messages -->
        <div class="messages" id="messages">
            <div class="empty-state">
                <div class="icon">üåç</div>
                <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫!</h3>
                <p>–ù–∞—á–Ω–∏—Ç–µ –ø–µ—á–∞—Ç–∞—Ç—å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥</p>
            </div>
        </div>
        
        <!-- Input Area -->
        <div class="input-area">
            <div class="input-controls">
                <textarea 
                    id="inputText" 
                    placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º..." 
                    rows="2"
                    onkeypress="handleKeyPress(event)">
                </textarea>
                
                <button class="voice-btn" id="voiceBtn" onclick="toggleRecording()">
                    üé§
                </button>
                
                <button class="send-btn" onclick="sendMessage()">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
            </div>
            
            <div class="info" id="info">
                üåê –ü–µ—Ä–µ–≤–æ–¥–∏–º —Å —Ä—É—Å—Å–∫–æ–≥–æ –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–∏–π
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        let messages = [];
        let selectedLanguage = 'ru';
        let isRecording = false;
        let isLoading = false;
        let recognition = null;
        let userId = null;
        let syncEnabled = false;
        let database = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadMessages();
            updatePlaceholder();
            updateInfo();
            setupSpeechRecognition();
            initializeFirebase();
            
            document.getElementById('languageSelect').addEventListener('change', function() {
                selectedLanguage = this.value;
                updatePlaceholder();
                updateInfo();
            });
        });

        function initializeFirebase() {
            try {
                // Public Firebase config (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–µ–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤)
                const firebaseConfig = {
                    apiKey: "AIzaSyBpZV5H0P0_demo_key_for_public_use",
                    authDomain: "translator-demo.firebaseapp.com",
                    databaseURL: "https://translator-demo-default-rtdb.firebaseio.com",
                    projectId: "translator-demo",
                    storageBucket: "translator-demo.appspot.com",
                    messagingSenderId: "123456789",
                    appId: "1:123456789:web:demo"
                };

                // Fallback to localStorage if Firebase fails
                try {
                    firebase.initializeApp(firebaseConfig);
                    database = firebase.database();
                    userId = getUserId();
                    console.log('Firebase initialized successfully');
                } catch (error) {
                    console.log('Firebase unavailable, using localStorage only:', error);
                    database = null;
                }
            } catch (error) {
                console.log('Firebase setup failed, using localStorage only');
                database = null;
            }
        }

        function getUserId() {
            let id = localStorage.getItem('translator-user-id');
            if (!id) {
                id = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('translator-user-id', id);
            }
            return id;
        }

        function toggleSync() {
            if (!database) {
                alert('‚ùå –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞\n\n‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –µ—Å—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç\n‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É');
                return;
            }

            if (syncEnabled) {
                disableSync();
            } else {
                enableSync();
            }
        }

        function enableSync() {
            if (!database || !userId) return;
            
            const userKey = prompt('üîó –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:\n\n‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –∫–æ–¥ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö\n‚Ä¢ –ù–∞–ø—Ä–∏–º–µ—Ä: "–º–æ—è_—Å–µ–º—å—è" –∏–ª–∏ "—Ä–∞–±–æ—Ç–∞123"');
            
            if (!userKey || userKey.trim().length < 3) {
                alert('‚ùå –ö–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞');
                return;
            }
            
            const syncKey = userKey.trim().toLowerCase().replace(/[^a-z0-9–∞-—è]/g, '_');
            localStorage.setItem('translator-sync-key', syncKey);
            
            syncEnabled = true;
            updateSyncButton();
            
            // Load existing messages from cloud
            loadMessagesFromCloud(syncKey);
            
            // Listen for new messages
            database.ref(`chats/${syncKey}/messages`).on('value', function(snapshot) {
                const cloudMessages = snapshot.val();
                if (cloudMessages) {
                    const messageArray = Object.keys(cloudMessages).map(key => ({
                        ...cloudMessages[key],
                        id: key
                    })).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    messages = messageArray;
                    saveMessages();
                    renderMessages();
                }
            });
            
            alert('‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞!\n\n‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ—Ç –∂–µ –∫–æ–¥ –Ω–∞ –¥—Ä—É–≥–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö\n‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏');
        }

        function disableSync() {
            if (database) {
                const syncKey = localStorage.getItem('translator-sync-key');
                if (syncKey) {
                    database.ref(`chats/${syncKey}/messages`).off();
                }
            }
            
            syncEnabled = false;
            localStorage.removeItem('translator-sync-key');
            updateSyncButton();
            alert('üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞\n\n–°–æ–æ–±—â–µ–Ω–∏—è –æ—Å—Ç–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ');
        }

        function updateSyncButton() {
            const btn = document.getElementById('syncBtn');
            if (syncEnabled) {
                btn.classList.add('sync-btn', 'active');
                btn.innerHTML = '‚úÖ –°–∏–Ω—Ö—Ä';
                btn.title = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –æ—Ç–∫–ª—é—á–∏—Ç—å';
            } else {
                btn.classList.remove('sync-btn', 'active');
                btn.innerHTML = 'üîÑ –°–∏–Ω—Ö—Ä';
                btn.title = '–í–∫–ª—é—á–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏';
            }
        }

        function loadMessagesFromCloud(syncKey) {
            if (!database) return;
            
            database.ref(`chats/${syncKey}/messages`).once('value')
                .then(function(snapshot) {
                    const cloudMessages = snapshot.val();
                    if (cloudMessages) {
                        const messageArray = Object.keys(cloudMessages).map(key => ({
                            ...cloudMessages[key],
                            id: key
                        })).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                        
                        messages = messageArray;
                        saveMessages();
                        renderMessages();
                    }
                })
                .catch(function(error) {
                    console.log('Failed to load from cloud:', error);
                });
        }

        function saveMessageToCloud(message) {
            if (!database || !syncEnabled) return;
            
            const syncKey = localStorage.getItem('translator-sync-key');
            if (!syncKey) return;
            
            database.ref(`chats/${syncKey}/messages`).push({
                ...message,
                userId: userId,
                deviceInfo: navigator.userAgent.substring(0, 50)
            }).catch(function(error) {
                console.log('Failed to sync message:', error);
            });
        }

        function setupSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                
                recognition.onstart = () => {
                    isRecording = true;
                    updateVoiceButton();
                };
                
                recognition.onend = () => {
                    isRecording = false;
                    updateVoiceButton();
                };
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('inputText').value = transcript;
                    setTimeout(() => sendMessage(), 500);
                };
                
                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    isRecording = false;
                    updateVoiceButton();
                };
            } else {
                document.getElementById('voiceBtn').style.display = 'none';
            }
        }

        function toggleRecording() {
            if (!recognition) {
                alert('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ');
                return;
            }
            
            if (isRecording) {
                recognition.stop();
            } else {
                recognition.lang = selectedLanguage === 'ru' ? 'ru-RU' : 'zh-CN';
                recognition.start();
            }
        }

        function updateVoiceButton() {
            const btn = document.getElementById('voiceBtn');
            if (isRecording) {
                btn.innerHTML = '‚èπÔ∏è';
                btn.classList.add('recording');
            } else {
                btn.innerHTML = 'üé§';
                btn.classList.remove('recording');
            }
        }

        function updatePlaceholder() {
            const textarea = document.getElementById('inputText');
            textarea.placeholder = selectedLanguage === 'ru' ? '–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º...' : 'Áî®‰∏≠ÊñáÂÜô...';
        }

        function updateInfo() {
            const info = document.getElementById('info');
            info.textContent = selectedLanguage === 'ru' 
                ? 'üåê –ü–µ—Ä–µ–≤–æ–¥–∏–º —Å —Ä—É—Å—Å–∫–æ–≥–æ –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–∏–π'
                : 'üåê –ü–µ—Ä–µ–≤–æ–¥–∏–º —Å –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ –Ω–∞ —Ä—É—Å—Å–∫–∏–π';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const inputText = document.getElementById('inputText').value.trim();
            if (!inputText || isLoading) return;
            
            isLoading = true;
            showLoading();
            
            try {
                const targetLanguage = selectedLanguage === 'ru' ? 'zh' : 'ru';
                const translatedText = await translateText(inputText, selectedLanguage, targetLanguage);
                
                const message = {
                    id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 5),
                    text: translatedText,
                    original_text: inputText,
                    language: targetLanguage,
                    timestamp: new Date().toISOString(),
                };
                
                messages.push(message);
                saveMessages();
                renderMessages();
                
                // Save to cloud if sync is enabled
                saveMessageToCloud(message);
                
                document.getElementById('inputText').value = '';
            } catch (error) {
                console.error('Translation error:', error);
                alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞');
            } finally {
                isLoading = false;
                hideLoading();
            }
        }

        async function translateText(text, fromLang, toLang) {
            try {
                // Try MyMemory API
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${fromLang}|${toLang}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.responseData && data.responseData.translatedText) {
                        return data.responseData.translatedText;
                    }
                }
            } catch (error) {
                console.log('API translation failed, using fallback:', error);
            }

            // Fallback translations
            const translations = {
                'ru-zh': {
                    '–ø—Ä–∏–≤–µ—Ç': '‰Ω†Â•Ω',
                    '—Å–ø–∞—Å–∏–±–æ': 'Ë∞¢Ë∞¢',
                    '–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è': 'ÂÜçËßÅ',
                    '–∫–∞–∫ –¥–µ–ª–∞': '‰Ω†Â•ΩÂêó',
                    '—Ö–æ—Ä–æ—à–æ': 'Â•ΩÁöÑ',
                    '–ø–ª–æ—Ö–æ': '‰∏çÂ•Ω',
                    '–¥–∞': 'ÊòØ',
                    '–Ω–µ—Ç': '‰∏ç',
                    '–ø–æ–∂–∞–ª—É–π—Å—Ç–∞': 'ËØ∑',
                    '–∏–∑–≤–∏–Ω–∏—Ç–µ': 'ÂØπ‰∏çËµ∑',
                    '—è –ª—é–±–ª—é —Ç–µ–±—è': 'ÊàëÁà±‰Ω†',
                    '—Å–∫–æ–ª—å–∫–æ —ç—Ç–æ —Å—Ç–æ–∏—Ç': 'ËøôË¶ÅÂ§öÂ∞ëÈí±',
                    '–≥–¥–µ —Ç—É–∞–ª–µ—Ç': 'ÂéïÊâÄÂú®Âì™Èáå',
                    '–ø–æ–º–æ–≥–∏—Ç–µ': 'Â∏ÆÂ∏ÆÊàë',
                    '—è –Ω–µ –ø–æ–Ω–∏–º–∞—é': 'Êàë‰∏çÊòéÁôΩ'
                },
                'zh-ru': {
                    '‰Ω†Â•Ω': '–ø—Ä–∏–≤–µ—Ç',
                    'Ë∞¢Ë∞¢': '—Å–ø–∞—Å–∏–±–æ',
                    'ÂÜçËßÅ': '–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è',
                    '‰Ω†Â•ΩÂêó': '–∫–∞–∫ –¥–µ–ª–∞',
                    'Â•ΩÁöÑ': '—Ö–æ—Ä–æ—à–æ',
                    '‰∏çÂ•Ω': '–ø–ª–æ—Ö–æ',
                    'ÊòØ': '–¥–∞',
                    '‰∏ç': '–Ω–µ—Ç',
                    'ËØ∑': '–ø–æ–∂–∞–ª—É–π—Å—Ç–∞',
                    'ÂØπ‰∏çËµ∑': '–∏–∑–≤–∏–Ω–∏—Ç–µ',
                    'ÊàëÁà±‰Ω†': '—è –ª—é–±–ª—é —Ç–µ–±—è',
                    'ËøôË¶ÅÂ§öÂ∞ëÈí±': '—Å–∫–æ–ª—å–∫–æ —ç—Ç–æ —Å—Ç–æ–∏—Ç',
                    'ÂéïÊâÄÂú®Âì™Èáå': '–≥–¥–µ —Ç—É–∞–ª–µ—Ç',
                    'Â∏ÆÂ∏ÆÊàë': '–ø–æ–º–æ–≥–∏—Ç–µ',
                    'Êàë‰∏çÊòéÁôΩ': '—è –Ω–µ –ø–æ–Ω–∏–º–∞—é'
                }
            };
            
            const key = `${fromLang}-${toLang}`;
            const translationMap = translations[key] || {};
            
            const words = text.toLowerCase().split(' ');
            const translatedWords = words.map(word => 
                translationMap[word] || `[${word}]`
            );
            
            return translatedWords.join(' ');
        }

        function showLoading() {
            const loading = document.createElement('div');
            loading.className = 'loading';
            loading.id = 'loading';
            loading.innerHTML = `
                <div>
                    <div class="spinner"></div>
                    <span>–ü–µ—Ä–µ–≤–æ–∂—É...</span>
                </div>
            `;
            document.getElementById('messages').appendChild(loading);
            scrollToBottom();
        }

        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.remove();
            }
        }

        function renderMessages() {
            const messagesContainer = document.getElementById('messages');
            
            if (messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üåç</div>
                        <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫!</h3>
                        <p>–ù–∞—á–Ω–∏—Ç–µ –ø–µ—á–∞—Ç–∞—Ç—å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥</p>
                    </div>
                `;
                return;
            }
            
            messagesContainer.innerHTML = messages.map(message => `
                <div class="message">
                    <div class="message-header">
                        <span>
                            ${message.language === 'ru' ? 'üá∑üá∫ –†—É—Å—Å–∫–∏–π' : 'üá®üá≥ ‰∏≠Êñá'}
                        </span>
                        <span>
                            ${new Date(message.timestamp).toLocaleTimeString()}
                        </span>
                    </div>
                    
                    ${message.original_text ? `
                        <div class="message-original">
                            <strong>–û—Ä–∏–≥–∏–Ω–∞–ª:</strong> ${message.original_text}
                        </div>
                    ` : ''}
                    
                    <div class="message-text">
                        ${message.text}
                    </div>
                </div>
            `).join('');
            
            scrollToBottom();
        }

        function scrollToBottom() {
            const messages = document.getElementById('messages');
            messages.scrollTop = messages.scrollHeight;
        }

        function clearChat() {
            if (syncEnabled) {
                const confirm = window.confirm('üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç?\n\n‚ö†Ô∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞!\n–≠—Ç–æ —É–¥–∞–ª–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –í–°–ï–• —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö.');
                if (!confirm) return;
                
                // Clear cloud data
                const syncKey = localStorage.getItem('translator-sync-key');
                if (database && syncKey) {
                    database.ref(`chats/${syncKey}/messages`).remove();
                }
            }
            
            messages = [];
            saveMessages();
            renderMessages();
        }

        function loadMessages() {
            const saved = localStorage.getItem('translator-messages');
            if (saved) {
                messages = JSON.parse(saved);
                renderMessages();
            }
            
            // Check if sync was enabled before
            const syncKey = localStorage.getItem('translator-sync-key');
            if (syncKey && database) {
                syncEnabled = true;
                updateSyncButton();
                
                // Reconnect to cloud sync
                database.ref(`chats/${syncKey}/messages`).on('value', function(snapshot) {
                    const cloudMessages = snapshot.val();
                    if (cloudMessages) {
                        const messageArray = Object.keys(cloudMessages).map(key => ({
                            ...cloudMessages[key],
                            id: key
                        })).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                        
                        messages = messageArray;
                        saveMessages();
                        renderMessages();
                    }
                });
            }
        }

        function saveMessages() {
            localStorage.setItem('translator-messages', JSON.stringify(messages));
        }
    </script>
</body>
</html>